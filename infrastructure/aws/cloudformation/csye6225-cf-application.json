  {
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "AWS CloudFormation Template",
    "Parameters" : {
      "keyname" : {
        "Type": "String",
        "Default": "AWS_key"
      },

      "AMIID" : {
        "Type" : "String" ,
        "Default" : "ami-015fcea9ff01ed264"
      },

      "Subnet1": {
        "Type": "AWS::EC2::Subnet::Id",
        "Description": "Subnet to launch the instance into.",
        "Default" :  "subnet-c6e9bc9a" 
      },

      "Subnet2": {
        "Type": "AWS::EC2::Subnet::Id",
        "Description": "Subnet to launch the instance into.",
        "Default" :  "subnet-86a3ebe1" 
        },

      "Subnet3": {
        "Type": "AWS::EC2::Subnet::Id",
        "Description": "Subnet to launch the instance into.",
        "Default" :  "subnet-6bfaad45" 
        },


      "VPC": {
        "Type": "AWS::EC2::VPC::Id",
        "Description": "VPC to launch the instance into.",
        "Default" : "vpc-78523602"
      }

    },


    "Resources" :{

      "DynamoDBTable" : {
      "Type" : "AWS::DynamoDB::Table",
       "Properties" : {
        "AttributeDefinitions" : [ {"AttributeName": "id",
                                    "AttributeType": "S"} ],
        "KeySchema" : [ {"AttributeName" : "id",
                          "KeyType" : "HASH"} ],
        "ProvisionedThroughput" : {"ReadCapacityUnits": "5",
                                   "WriteCapacityUnits" : "5"},
        "TimeToLiveSpecification": {"AttributeName": "ttl_timestamp",
                                    "Enabled": "TRUE"},
        "TableName" : "csye6225"

      }
    },

    "InstanceSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupName" : "csye6225-webapp",
        "GroupDescription" : "webapp security group",
        "VpcId" : {"Ref": "VPC"},    
        "SecurityGroupIngress" : [{
          "IpProtocol" : "tcp", 
          "FromPort": 22,
          "ToPort" : 22,
          "CidrIp" : "0.0.0.0/0"
        },
        {
          "IpProtocol" : "tcp",                    
          "FromPort": 80,
          "ToPort" : 80,                    
          "CidrIp" : "0.0.0.0/0"

        },
        {
          "IpProtocol" : "tcp",                    
          "FromPort": 8080,
          "ToPort" : 8080,                    
          "CidrIp" : "0.0.0.0/0"

        },
        {
          "IpProtocol" : "tcp",                    
          "FromPort": 443,
          "ToPort" : 443,                    
          "CidrIp" : "0.0.0.0/0"

        },
        {
          "IpProtocol" : "tcp",                    
          "FromPort": 3306,
          "ToPort" : 3306,                    
          "CidrIp" : "0.0.0.0/0"

        }            
      ]
      }
    },
    
    "DBSecurityGroup": {
      "Type": "AWS::RDS::DBSecurityGroup",
      "Properties": {
        "EC2VpcId" : {"Ref": "VPC"},
        "DBSecurityGroupIngress": [
          {"EC2SecurityGroupId": {
             "Fn::GetAtt": [
               "InstanceSecurityGroup",
                "GroupId"
              ]
           }
         }
       ],
        "GroupDescription": "Enable TCP access via port 3306"
      }
    },


    "ec2instance":{
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "BlockDeviceMappings" : [
          {
            "DeviceName" : "/dev/sda1",
            "Ebs" : {
              "DeleteOnTermination" : true,
              "VolumeSize" : 20,
              "VolumeType" : "gp2"
            }
          }
        ],
        "ImageId" :{"Ref" : "AMIID"},
        "InstanceInitiatedShutdownBehavior" : "terminate",
        "InstanceType" : "t2.micro",
        "KeyName" :  {"Ref": "keyname"},
        "SecurityGroupIds" :[{
                    "Fn::GetAtt": [
                        "InstanceSecurityGroup",
                        "GroupId"
                    ]
                  }],
        "SubnetId" : {"Ref" : "Subnet1" },
        "UserData" : {
                      "Fn::Base64": {
                          "Fn::Join": [
                              "",
                              [
                                  "#!/bin/bash -xe \n",
                                  "sudo yum update -y \n"
                              ]
                            ]
                        }
                      }
                    }
    },

   "DBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
          "DBSubnetGroupDescription": "Subnets for RDS DB Instance",
          "SubnetIds": [ { "Ref" : "Subnet3" },
                         { "Ref" : "Subnet2"} ]
        }
    },


    "DBInstance":{
      "Type" : "AWS::RDS::DBInstance",
      "Properties" : {
        "AllocatedStorage" : "20",
        "DBInstanceClass" : "db.t2.medium",
        "DBInstanceIdentifier" : "csye6225-su19",
        "DBName" : "csye6225",
        "DBSecurityGroups" : [{"Ref":"DBSecurityGroup"}],
        "DBSubnetGroupName" :{"Ref":"DBSubnetGroup"},
        "Engine" : "MySQL",
        "MasterUserPassword" : "csye6225password",
        "MasterUsername" : "csye6225master",
        "MultiAZ" : false,
        "PubliclyAccessible" : true,
        "VPCSecurityGroups" :  [{"Ref":"DBSecurityGroup"}]
      }
    }
  }
}
